<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Access Request Portal - Vitens</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, Helvetica, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }

        .vitens-header {
            background: #2c3c8a;
            color: white;
            padding: 20px 40px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .vitens-logo-section {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
            margin-bottom: 15px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .settings-icon {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1.5em;
        }

        .settings-icon:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: rotate(45deg);
        }

        .vitens-logo {
            background: white;
            padding: 8px 20px;
            border-radius: 4px;
            height: 60px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .vitens-logo:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .vitens-logo img {
            height: 100%;
            width: auto;
            object-fit: contain;
        }

        .header-title {
            font-size: 2em;
            font-weight: 600;
        }

        .header-subtitle {
            font-size: 1em;
            opacity: 0.95;
            margin-left: 2px;
        }

        /* Mode Switch */
        .mode-switch-container {
            display: block;
            padding: 12px;
            background: #f0f4ff;
            border-radius: 6px;
            border: 2px solid #4aaedf;
        }

        .mode-switch-label {
            font-weight: 600;
            color: #2c3c8a;
            font-size: 0.9em;
            display: block;
            margin-bottom: 8px;
        }

        .mode-switch {
            display: flex;
            background: white;
            border-radius: 6px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .mode-option {
            flex: 1;
            padding: 10px 8px;
            background: white;
            border: 2px solid #ddd;
            color: #666;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.85em;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .mode-option:first-child {
            border-radius: 6px 0 0 6px;
        }

        .mode-option:last-child {
            border-radius: 0 6px 6px 0;
        }

        .mode-option:hover:not(.active) {
            background: #f5f5f5;
        }

        .mode-option.active {
            background: #2c3c8a;
            color: white;
            border-color: #2c3c8a;
            box-shadow: 0 2px 8px rgba(44, 60, 138, 0.3);
        }

        .mode-status {
            font-size: 0.8em;
            color: #666;
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 8px;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
        }

        .status-indicator.online {
            background: #4caf50;
            box-shadow: 0 0 8px rgba(76, 175, 80, 0.5);
        }

        .status-indicator.offline {
            background: #ff9800;
        }

        .status-indicator.demo {
            background: #2196f3;
        }

        .excel-upload {
            display: none;
            margin-bottom: 20px;
            padding: 12px;
            background: white;
            border-radius: 4px;
            border: 2px dashed #4aaedf;
        }

        .excel-upload.active {
            display: block;
        }

        .excel-upload label {
            font-size: 0.85em;
            margin-bottom: 6px;
            display: block;
            color: #2c3c8a;
        }

        .excel-upload input[type="file"] {
            font-size: 0.75em;
            width: 100%;
        }

        .excel-info {
            font-size: 0.75em;
            color: #666;
            margin-top: 6px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px 40px;
        }

        .main-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
        }

        .search-section {
            background: white;
            padding: 30px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .section-title {
            font-size: 1.5em;
            color: #2c3c8a;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }

        .search-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .search-input:focus {
            outline: none;
            border-color: #4aaedf;
        }

        .btn-primary {
            padding: 12px 30px;
            background: #2c3c8a;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
            font-weight: 500;
        }

        .btn-primary:hover {
            background: #1f2b5f;
        }

        .btn-secondary {
            padding: 12px 30px;
            background: #4aaedf;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
            font-weight: 500;
        }

        .btn-secondary:hover {
            background: #3a9ecf;
        }

        .results-section {
            margin-top: 20px;
        }

        .results-header {
            font-size: 1.2em;
            margin-bottom: 15px;
            color: #2c3c8a;
            font-weight: 600;
        }

        .result-item {
            background: #f9f9f9;
            border: 1px solid #e0e0e0;
            border-left: 4px solid #4aaedf;
            border-radius: 4px;
            padding: 20px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }

        .result-item:hover {
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .result-info {
            flex: 1;
        }

        .result-name {
            font-size: 1.1em;
            font-weight: 600;
            color: #2c3c8a;
            margin-bottom: 6px;
        }

        .result-description {
            color: #555;
            font-size: 0.95em;
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .result-type {
            display: inline-block;
            padding: 4px 12px;
            background: #4aaedf;
            color: white;
            border-radius: 3px;
            font-size: 0.85em;
            font-weight: 500;
        }

        .add-btn {
            padding: 10px 24px;
            background: #4aaedf;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 15px;
            transition: all 0.3s;
            font-weight: 500;
        }

        .add-btn:hover {
            background: #3a9ecf;
        }

        .add-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .cart-section {
            background: white;
            padding: 30px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        .cart-block {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 6px;
            border: 2px solid #e0e0e0;
            margin-top: 25px;
        }

        .cart-title {
            font-size: 1.5em;
            margin-bottom: 20px;
            color: #2c3c8a;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 600;
        }

        .cart-badge {
            background: #4aaedf;
            color: white;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7em;
            font-weight: 600;
        }

        .cart-item {
            background: #f9f9f9;
            border-left: 3px solid #2c3c8a;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .cart-item-info {
            flex: 1;
        }

        .cart-item-name {
            font-weight: 600;
            color: #2c3c8a;
            margin-bottom: 4px;
            font-size: 0.95em;
        }

        .cart-item-type {
            font-size: 0.85em;
            color: #666;
        }

        .remove-btn {
            background: #d32f2f;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.3s;
        }

        .remove-btn:hover {
            background: #b71c1c;
        }

        .order-btn {
            width: 100%;
            padding: 15px;
            background: #2c3c8a;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            transition: background 0.3s;
        }

        .order-btn:hover:not(:disabled) {
            background: #1f2b5f;
        }

        .order-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .empty-cart {
            text-align: center;
            color: #999;
            padding: 40px 20px;
        }

        .empty-cart-icon {
            font-size: 3em;
            margin-bottom: 10px;
            opacity: 0.5;
        }

        .success-message {
            background: #4caf50;
            color: white;
            padding: 18px 24px;
            border-radius: 4px;
            margin-bottom: 20px;
            display: none;
            animation: slideDown 0.3s ease;
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
        }

        .error-message {
            background: #d32f2f;
            color: white;
            padding: 18px 24px;
            border-radius: 4px;
            margin-bottom: 20px;
            display: none;
            animation: slideDown 0.3s ease;
            box-shadow: 0 2px 8px rgba(211, 47, 47, 0.3);
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-spinner {
            background: white;
            padding: 40px;
            border-radius: 8px;
            text-align: center;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2c3c8a;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .no-results {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        /* Settings Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            animation: fadeIn 0.3s ease;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            width: 90%;
            max-width: 700px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            animation: slideUp 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            background: #2c3c8a;
            color: white;
            padding: 25px 30px;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 1.8em;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 2em;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.3s;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .modal-body {
            padding: 30px;
        }

        .settings-section {
            margin-bottom: 30px;
            padding-bottom: 30px;
            border-bottom: 1px solid #e0e0e0;
        }

        .settings-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .settings-section h3 {
            color: #2c3c8a;
            font-size: 1.3em;
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 0.95em;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 15px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #4aaedf;
        }

        .form-group small {
            display: block;
            color: #666;
            margin-top: 5px;
            font-size: 0.85em;
        }

        .form-group input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            font-weight: normal;
        }

        .settings-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }

        .btn-test {
            padding: 12px 24px;
            background: #4aaedf;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 15px;
            transition: background 0.3s;
        }

        .btn-test:hover {
            background: #3a9ecf;
        }

        .btn-save {
            padding: 12px 30px;
            background: #2c3c8a;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: background 0.3s;
        }

        .btn-save:hover {
            background: #1f2b5f;
        }

        .connection-status {
            padding: 12px 15px;
            border-radius: 4px;
            margin-top: 15px;
            display: none;
        }

        .connection-status.success {
            background: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #4caf50;
        }

        .connection-status.error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #f44336;
        }

        /* Tools Navigation Menu */
        .tools-nav {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .tools-nav-link {
            color: white;
            text-decoration: none;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 0.85em;
            transition: all 0.3s;
            background: rgba(255, 255, 255, 0.15);
            display: flex;
            align-items: center;
            gap: 5px;
            white-space: nowrap;
        }

        .tools-nav-link:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
        }

        .tools-nav-link.active {
            background: #4aaedf;
            font-weight: 600;
        }

        /* Responsive: verberg tekst op kleinere schermen, alleen emoji's tonen */
        @media (max-width: 768px) {
            .tools-nav-link .nav-text {
                display: none;
            }
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .cart-section {
                position: static;
            }

            .container {
                padding: 20px;
            }

            .vitens-header {
                padding: 15px 20px;
            }
        }
    </style>
</head>
<body>
    <div class="vitens-header">
        <div class="vitens-logo-section">
            <a href="index.html" class="vitens-logo" title="Terug naar home">
                <img src="https://www.vitens.nl/-/media/Project/Vitens/VitensNl/vitens-logo.jpg" alt="Vitens Logo">
            </a>
            <div class="header-right">
                <!-- Tools Navigation -->
                <nav class="tools-nav">
                    <a href="test-grc-connection.html" class="tools-nav-link" title="GRC Connection Test">
                        <span>🔧</span><span class="nav-text"> GRC Test</span>
                    </a>
                    <a href="inspect-excel.html" class="tools-nav-link" title="Excel Inspector">
                        <span>📊</span><span class="nav-text"> Excel</span>
                    </a>
                </nav>
                <div class="settings-icon" onclick="openSettings()" title="Instellingen">
                    ⚙️
                </div>
            </div>
        </div>
        <div class="header-title">Access Request Portal</div>
        <div class="header-subtitle">Vraag eenvoudig toegang aan tot applicaties en SAP rollen</div>
    </div>

    <div class="container">
        <div class="main-content">
            <div class="search-section">
                <div class="success-message" id="successMessage"></div>
                <div class="error-message" id="errorMessage"></div>

                <h2 class="section-title">Zoeken naar toegang</h2>

                <div class="search-box">
                    <input
                        type="text"
                        class="search-input"
                        id="searchInput"
                        placeholder="Zoek naar Visio, SAP rollen of applicaties..."
                        autocomplete="off"
                    >
                    <button class="btn-primary" onclick="performSearch()">Zoeken</button>
                </div>

                <!-- Filters (alleen zichtbaar in Excel/Online mode) -->
                <div id="filterSection" style="display: none; margin-bottom: 20px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 10px; align-items: end;">
                        <div>
                            <label for="afdelingFilter" style="display: block; font-weight: 600; margin-bottom: 5px; color: #2c3c8a; font-size: 0.9em;">
                                🏢 Filter op Afdeling (Functiegebied)
                            </label>
                            <select id="afdelingFilter" class="search-input" onchange="performSearch()">
                                <option value="">Alle afdelingen</option>
                            </select>
                        </div>
                        <div>
                            <label for="bedrijfsprocesFilter" style="display: block; font-weight: 600; margin-bottom: 5px; color: #2c3c8a; font-size: 0.9em;">
                                ⚙️ Filter op Bedrijfsproces
                            </label>
                            <select id="bedrijfsprocesFilter" class="search-input" onchange="performSearch()">
                                <option value="">Alle bedrijfsprocessen</option>
                            </select>
                        </div>
                        <div>
                            <button class="btn-secondary" onclick="resetFilters()" style="width: 100%;">
                                Reset Filters
                            </button>
                        </div>
                    </div>
                </div>

                <div class="results-section">
                    <h3 class="results-header">Zoekresultaten</h3>
                    <div id="resultsContainer">
                        <div class="no-results">
                            Voer een zoekterm in om te beginnen met zoeken
                        </div>
                    </div>
                </div>
            </div>

            <div class="cart-section">
                <!-- Mode Switch -->
                <div class="mode-switch-container">
                    <span class="mode-switch-label">Modus:</span>
                    <div class="mode-switch">
                        <div class="mode-option active" onclick="switchMode('demo')" id="mode-demo">
                            <span>🎯</span> Demo
                        </div>
                        <div class="mode-option" onclick="switchMode('excel')" id="mode-excel">
                            <span>📊</span> Excel
                        </div>
                        <div class="mode-option" onclick="switchMode('online')" id="mode-online">
                            <span>🌐</span> Online
                        </div>
                    </div>
                    <div class="mode-status" id="modeStatus">
                        <span class="status-indicator demo"></span>
                        <span>Demo Modus</span>
                    </div>
                </div>

                <!-- Excel Upload (alleen zichtbaar in Excel mode) -->
                <div class="excel-upload" id="excelUpload">
                    <label for="excelFile"><strong>Upload BOR.xlsx:</strong></label>
                    <input type="file" id="excelFile" accept=".xlsx,.xls" onchange="handleExcelUpload(event)">
                    <div class="excel-info">
                        📁 Upload voor 8000+ rollen
                    </div>
                    <div id="excelStatus" class="excel-info" style="margin-top: 8px; display: none;"></div>
                </div>

                <!-- Winkelwagen sectie (als los blok) -->
                <div class="cart-block">
                    <h2 class="cart-title">
                        Winkelwagen
                        <span class="cart-badge" id="cartBadge">0</span>
                    </h2>
                    <div id="cartContainer">
                        <div class="empty-cart">
                            <div class="empty-cart-icon">🛒</div>
                            <p>Je winkelwagen is leeg</p>
                        </div>
                    </div>
                    <button class="order-btn" id="orderBtn" onclick="submitOrder()" disabled>
                        Bestelling Indienen
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <p>Bezig met verwerken...</p>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>⚙️ GRC Instellingen</h2>
                <button class="modal-close" onclick="closeSettings()">×</button>
            </div>
            <div class="modal-body">
                <form id="settingsForm">
                    <!-- Server Configuratie -->
                    <div class="settings-section">
                        <h3>Server Configuratie</h3>
                        <div class="form-group">
                            <label for="grcServerUrl">GRC Server URL *</label>
                            <input type="text" id="grcServerUrl" placeholder="https://grc.vitens.lan" required>
                            <small>De basis URL van je SAP GRC 12.0 server</small>
                        </div>
                        <div class="form-group">
                            <label for="grcTimeout">Timeout (milliseconden)</label>
                            <input type="number" id="grcTimeout" value="30000" min="5000" max="120000">
                            <small>Maximale wachttijd voor API calls (standaard: 30000ms)</small>
                        </div>
                    </div>

                    <!-- Authenticatie -->
                    <div class="settings-section">
                        <h3>Authenticatie (Basic Auth)</h3>
                        <div class="form-group">
                            <label for="grcUsername">Service Account Username *</label>
                            <input type="text" id="grcUsername" placeholder="GRC_SERVICE_USER" required autocomplete="off">
                            <small>Service account voor GRC web service calls</small>
                        </div>
                        <div class="form-group">
                            <label for="grcPassword">Service Account Password *</label>
                            <input type="password" id="grcPassword" placeholder="••••••••" required autocomplete="off">
                            <small>Wachtwoord wordt veilig opgeslagen in browser localStorage</small>
                        </div>
                    </div>

                    <!-- Backend Configuratie -->
                    <div class="settings-section">
                        <h3>Backend Configuratie</h3>
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="useBackend">
                                GRC Backend Integratie Activeren
                            </label>
                            <small>Schakel dit in om live te connecten met SAP GRC. Uit = lokale test data</small>
                        </div>
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="enablePolling">
                                Automatische Status Polling
                            </label>
                            <small>Poll elke 15 minuten voor status updates van access requests</small>
                        </div>
                        <div class="form-group">
                            <label for="pollingInterval">Polling Interval (minuten)</label>
                            <input type="number" id="pollingInterval" value="15" min="5" max="60">
                            <small>Hoe vaak de app checkt voor status updates</small>
                        </div>
                    </div>

                    <!-- Web Services Endpoints -->
                    <div class="settings-section">
                        <h3>Web Services (SOAP Endpoints)</h3>
                        <div class="form-group">
                            <label for="wsSearchRoles">GRAC_SEARCH_ROLES_WS Endpoint</label>
                            <input type="text" id="wsSearchRoles"
                                   value="/sap/bc/srt/rfc/sap/grac_search_roles_ws/002/grac_search_roles_ws/grac_search_roles_ws">
                            <small>Endpoint voor zoeken naar SAP rollen</small>
                        </div>
                        <div class="form-group">
                            <label for="wsCreateRequest">GRAC_ORG_ASGN_REQUEST_WS Endpoint</label>
                            <input type="text" id="wsCreateRequest"
                                   value="/sap/bc/srt/rfc/sap/grac_org_asgn_request_ws/002/grac_org_asgn_request_ws/grac_org_asgn_request_ws">
                            <small>Endpoint voor aanmaken van access requests</small>
                        </div>
                        <div class="form-group">
                            <label for="wsRequestStatus">GRAC_REQUEST_STATUS_WS Endpoint</label>
                            <input type="text" id="wsRequestStatus"
                                   value="/sap/bc/srt/rfc/sap/grac_request_status_ws/002/grac_request_status_ws/grac_request_status_ws">
                            <small>Endpoint voor ophalen van request status</small>
                        </div>
                    </div>

                    <!-- Test & Opslaan -->
                    <div class="connection-status" id="connectionStatus"></div>

                    <div class="settings-actions">
                        <button type="button" class="btn-test" onclick="testConnection()">Test Connectie</button>
                        <button type="submit" class="btn-save">Opslaan</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- GRC Configuratie -->
    <script src="grc-config.js"></script>

    <!-- SheetJS voor Excel parsing -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <script>
        // GRC_CONFIG wordt geladen vanuit grc-config.js

        // ============================================
        // MODE MANAGEMENT
        // ============================================

        let currentMode = 'demo'; // 'demo', 'excel', 'online'
        let excelData = []; // Data uit BOR.xlsx

        /**
         * Switch tussen verschillende modi
         */
        function switchMode(mode) {
            currentMode = mode;

            // Update UI
            document.querySelectorAll('.mode-option').forEach(el => el.classList.remove('active'));
            document.getElementById(`mode-${mode}`).classList.add('active');

            // Update status indicator
            const statusDiv = document.getElementById('modeStatus');
            const indicator = statusDiv.querySelector('.status-indicator');
            indicator.className = `status-indicator ${mode === 'online' ? 'online' : mode === 'excel' ? 'offline' : 'demo'}`;

            let statusText = '';
            switch(mode) {
                case 'demo':
                    statusText = 'Demo Modus - Snelle test data (Visio & P2P rollen)';
                    document.getElementById('excelUpload').classList.remove('active');
                    document.getElementById('filterSection').style.display = 'none';
                    break;
                case 'excel':
                    statusText = 'Offline Modus - Upload BOR.xlsx voor volledige data';
                    document.getElementById('excelUpload').classList.add('active');
                    if (excelData.length > 0) {
                        statusText = `Offline Modus - ${excelData.length} rollen geladen uit Excel`;
                        document.getElementById('filterSection').style.display = 'block';
                    } else {
                        document.getElementById('filterSection').style.display = 'none';
                    }
                    break;
                case 'online':
                    statusText = 'Online Modus - Live connectie met SAP GRC';
                    document.getElementById('excelUpload').classList.remove('active');
                    document.getElementById('filterSection').style.display = 'block';
                    break;
            }

            statusDiv.querySelector('span:last-child').textContent = statusText;

            // Clear search results
            document.getElementById('resultsContainer').innerHTML =
                '<div class="no-results">Voer een zoekterm in om te beginnen met zoeken</div>';
            document.getElementById('searchInput').value = '';

            console.log(`Switched to ${mode} mode`);
        }

        /**
         * Vul de filter dropdowns met unieke waarden uit excelData
         */
        function populateFilters() {
            // Show filter section
            document.getElementById('filterSection').style.display = 'block';

            // Extract unique Afdelingen (Functiegebied)
            const afdelingen = [...new Set(
                excelData
                    .map(item => item.functiegebied)
                    .filter(val => val && val !== 'NaN' && val.trim() !== '')
            )].sort();

            // Extract unique Bedrijfsprocessen
            const bedrijfsprocessen = [...new Set(
                excelData
                    .map(item => item.bedrijfsproces)
                    .filter(val => val && val !== 'NaN' && val.trim() !== '')
            )].sort();

            // Populate Afdeling dropdown
            const afdelingFilter = document.getElementById('afdelingFilter');
            afdelingFilter.innerHTML = '<option value="">Alle afdelingen</option>';
            afdelingen.forEach(afdeling => {
                const option = document.createElement('option');
                option.value = afdeling;
                option.textContent = afdeling;
                afdelingFilter.appendChild(option);
            });

            // Populate Bedrijfsproces dropdown
            const bedrijfsprocesFilter = document.getElementById('bedrijfsprocesFilter');
            bedrijfsprocesFilter.innerHTML = '<option value="">Alle bedrijfsprocessen</option>';
            bedrijfsprocessen.forEach(proces => {
                const option = document.createElement('option');
                option.value = proces;
                option.textContent = proces;
                bedrijfsprocesFilter.appendChild(option);
            });

            console.log(`Filters populated: ${afdelingen.length} afdelingen, ${bedrijfsprocessen.length} bedrijfsprocessen`);
        }

        /**
         * Reset alle filters
         */
        function resetFilters() {
            document.getElementById('afdelingFilter').value = '';
            document.getElementById('bedrijfsprocesFilter').value = '';
            performSearch();
        }

        /**
         * Handle Excel file upload
         */
        function handleExcelUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const statusDiv = document.getElementById('excelStatus');
            statusDiv.style.display = 'block'; // Make sure it's visible
            statusDiv.style.color = '#666';
            statusDiv.textContent = 'Bezig met laden van Excel bestand...';

            const reader = new FileReader();

            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });

                    // Zoek naar "Data" tabblad (BOR.xlsx specifiek)
                    let sheetName = 'Data';
                    if (!workbook.SheetNames.includes(sheetName)) {
                        // Als "Data" niet bestaat, probeer "data" (lowercase)
                        sheetName = 'data';
                        if (!workbook.SheetNames.includes(sheetName)) {
                            // Als beide niet bestaan, gebruik eerste sheet
                            sheetName = workbook.SheetNames[0];
                            console.warn(`Sheet "Data" of "data" niet gevonden, gebruik ${sheetName}`);
                        }
                    }

                    console.log(`Loading data from sheet: ${sheetName}`);
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);

                    console.log(`Raw Excel data rows: ${jsonData.length}`);

                    // Parse Excel data naar ons formaat
                    excelData = parseExcelData(jsonData);

                    console.log(`Parsed roles: ${excelData.length}`);

                    if (excelData.length === 0) {
                        statusDiv.style.color = '#ff9800';
                        statusDiv.textContent = `⚠ Geen rollen gevonden in ${sheetName} sheet. Controleer of het juiste bestand is geüpload.`;
                    } else {
                        statusDiv.style.color = '#4caf50';
                        statusDiv.textContent = `✓ ${excelData.length} rollen succesvol geladen uit ${file.name}`;

                        // Update mode status
                        const modeStatus = document.getElementById('modeStatus');
                        modeStatus.querySelector('span:last-child').textContent =
                            `Offline Modus - ${excelData.length} rollen geladen uit Excel`;

                        // Populate filters
                        populateFilters();

                        // Hide success message and collapse upload section after 3 seconds
                        setTimeout(() => {
                            statusDiv.style.display = 'none';
                            // Collapse the entire upload section for cleaner UI
                            document.getElementById('excelUpload').style.display = 'none';
                        }, 3000);
                    }

                    console.log(`Loaded ${excelData.length} roles from Excel (sheet: ${sheetName})`);

                } catch (error) {
                    console.error('Error parsing Excel:', error);
                    statusDiv.style.color = '#d32f2f';
                    statusDiv.textContent = `✗ Fout bij laden van Excel: ${error.message}`;
                    excelData = [];
                }
            };

            reader.onerror = function(error) {
                console.error('Error reading file:', error);
                statusDiv.style.color = '#d32f2f';
                statusDiv.textContent = '✗ Fout bij lezen van bestand';
                excelData = [];
            };

            reader.readAsArrayBuffer(file);
        }

        /**
         * Parse Excel data naar ons formaat
         * Verwacht kolommen uit BOR.xlsx: Rolnaam, Applicatietype, Roltype, Bedrijfsproces, etc.
         */
        function parseExcelData(jsonData) {
            return jsonData.map((row, index) => {
                // BOR.xlsx specifieke kolommen
                const rolnaam = row.Rolnaam || row.rolnaam || '';
                const applicatietype = row.Applicatietype || row.applicatietype || '';
                const roltype = row.Roltype || row.roltype || '';
                const bedrijfsproces = row.Bedrijfsproces || row.bedrijfsproces || '';
                const subproces = row.Subproces || row.subproces || '';
                const functiegebied = row.Functiegebied || row.functiegebied || '';
                const constellatie = row.Constellatie || row.constellatie || '';

                // Maak een beschrijving uit beschikbare velden
                let description = '';
                if (bedrijfsproces && bedrijfsproces !== 'NaN') {
                    description += bedrijfsproces;
                }
                if (subproces && subproces !== 'NaN' && subproces !== 'Generiek') {
                    description += (description ? ' - ' : '') + subproces;
                }
                if (functiegebied && functiegebied !== 'NaN') {
                    description += (description ? ' | ' : '') + 'Functiegebied: ' + functiegebied;
                }
                if (!description) {
                    description = applicatietype || 'Geen beschrijving beschikbaar';
                }

                // Bepaal type: gebruik Roltype of Applicatietype
                const type = roltype || applicatietype || 'SAP Rol';

                return {
                    id: index + 1000, // Offset om niet te conflicteren met demo data
                    name: rolnaam,
                    description: description,
                    type: type,
                    system: constellatie || '',
                    applicatietype: applicatietype,
                    bedrijfsproces: bedrijfsproces,
                    subproces: subproces,
                    functiegebied: functiegebied,
                    category: 'excel'
                };
            }).filter(item => item.name && item.name.trim() !== ''); // Filter lege entries
        }

        // ============================================
        // FUZZY SEARCH IMPLEMENTATION
        // ============================================

        /**
         * Levenshtein distance algoritme voor fuzzy matching
         * Berekent het aantal aanpassingen nodig om string a naar string b te transformeren
         */
        function levenshteinDistance(a, b) {
            const matrix = [];

            // Initialiseer eerste rij en kolom
            for (let i = 0; i <= b.length; i++) {
                matrix[i] = [i];
            }
            for (let j = 0; j <= a.length; j++) {
                matrix[0][j] = j;
            }

            // Vul de matrix
            for (let i = 1; i <= b.length; i++) {
                for (let j = 1; j <= a.length; j++) {
                    if (b.charAt(i - 1) === a.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1, // substitution
                            matrix[i][j - 1] + 1,     // insertion
                            matrix[i - 1][j] + 1      // deletion
                        );
                    }
                }
            }

            return matrix[b.length][a.length];
        }

        /**
         * Bereken fuzzy match score tussen zoekterm en tekst
         * Hogere score = betere match
         */
        function fuzzyMatchScore(searchTerm, text) {
            if (!searchTerm || !text) return 0;

            searchTerm = searchTerm.toLowerCase();
            text = text.toLowerCase();

            // Exacte match = hoogste score
            if (text === searchTerm) return 1000;

            // Begint met zoekterm = zeer hoge score
            if (text.startsWith(searchTerm)) return 900;

            // Bevat de zoekterm = hoge score
            if (text.includes(searchTerm)) return 800;

            // Fuzzy matching met Levenshtein distance
            const distance = levenshteinDistance(searchTerm, text);
            const maxLength = Math.max(searchTerm.length, text.length);

            // Converteer distance naar similarity score (0-100)
            const similarity = ((maxLength - distance) / maxLength) * 100;

            // Ook checken voor partial matches in woorden
            const words = text.split(/[\s_-]+/);
            let bestWordScore = 0;

            for (const word of words) {
                // Check of zoekterm match met begin van een woord
                if (word.startsWith(searchTerm)) {
                    bestWordScore = Math.max(bestWordScore, 700);
                    continue;
                }

                // Check fuzzy match per woord
                const wordDistance = levenshteinDistance(searchTerm, word);
                const wordMaxLength = Math.max(searchTerm.length, word.length);
                const wordSimilarity = ((wordMaxLength - wordDistance) / wordMaxLength) * 100;

                // Als een woord een goede fuzzy match is
                if (wordSimilarity > 70) {
                    bestWordScore = Math.max(bestWordScore, 600 + wordSimilarity);
                }
            }

            // Return beste score
            return Math.max(similarity, bestWordScore);
        }

        /**
         * Fuzzy search functie die items ranked op relevantie
         */
        function fuzzySearch(searchTerm, items) {
            if (!searchTerm || searchTerm.trim() === '') {
                return [];
            }

            const threshold = 50; // Minimale score om als match te tellen

            // Bereken score voor elk item
            const scoredItems = items.map(item => {
                // Check scores voor verschillende velden
                const nameScore = fuzzyMatchScore(searchTerm, item.name);
                const descScore = fuzzyMatchScore(searchTerm, item.description);
                const typeScore = fuzzyMatchScore(searchTerm, item.type);
                const categoryScore = item.category ? fuzzyMatchScore(searchTerm, item.category) : 0;

                // Neem hoogste score (naam is belangrijkst, dus vermenigvuldig met 2)
                const maxScore = Math.max(
                    nameScore * 2,
                    descScore,
                    typeScore,
                    categoryScore
                );

                return {
                    item: item,
                    score: maxScore
                };
            });

            // Filter items die boven threshold scoren en sorteer op score
            return scoredItems
                .filter(x => x.score >= threshold)
                .sort((a, b) => b.score - a.score)
                .map(x => x.item);
        }

        // ============================================
        // LOKALE DATA (Fallback als GRC niet beschikbaar is)
        // ============================================
        const localAvailableAccess = [
            {
                id: 1,
                name: "Microsoft Visio Professional",
                description: "Diagrammen en flowcharts maken",
                type: "Applicatie",
                category: "visio"
            },
            {
                id: 2,
                name: "Microsoft Visio Standard",
                description: "Basis diagrammen en tekeningen",
                type: "Applicatie",
                category: "visio"
            },
            {
                id: 3,
                name: "SAP_P2P_BUYER",
                description: "Purchase-to-Pay: Inkoper rechten voor het aanmaken van inkooporders",
                type: "SAP Rol",
                category: "p2p"
            },
            {
                id: 4,
                name: "SAP_P2P_APPROVER",
                description: "Purchase-to-Pay: Goedkeuren van inkooporders en facturen",
                type: "SAP Rol",
                category: "p2p"
            },
            {
                id: 5,
                name: "SAP_P2P_REQUESTER",
                description: "Purchase-to-Pay: Aanmaken van inkoopaanvragen",
                type: "SAP Rol",
                category: "p2p"
            },
            {
                id: 6,
                name: "SAP_P2P_RECEIVER",
                description: "Purchase-to-Pay: Goederenontvanst registreren",
                type: "SAP Rol",
                category: "p2p"
            },
            {
                id: 7,
                name: "SAP_P2P_VENDOR_MANAGER",
                description: "Purchase-to-Pay: Leveranciersbeheer en stamgegevens",
                type: "SAP Rol",
                category: "p2p"
            },
            {
                id: 8,
                name: "SAP_P2P_INVOICE_PROCESSOR",
                description: "Purchase-to-Pay: Factuurverwerking en controle",
                type: "SAP Rol",
                category: "p2p"
            }
        ];

        let cart = [];
        let searchResults = [];
        let useBackend = false; // Zet op true als GRC backend beschikbaar is

        // ============================================
        // GRC AC BACKEND FUNCTIES
        // ============================================

        /**
         * Generieke functie voor SOAP calls naar GRC AC backend
         * SAP GRC 12.0 gebruikt SOAP web services
         */
        async function callGrcSoapApi(webservice, soapBody) {
            const serviceConfig = GRC_CONFIG.webservices[webservice];
            const url = GRC_CONFIG.server.baseUrl + serviceConfig.endpoint;

            // SOAP Envelope template
            const soapEnvelope = `<?xml version="1.0" encoding="UTF-8"?>
<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:urn="urn:sap-com:document:sap:rfc:functions">
    <soapenv:Header/>
    <soapenv:Body>
        ${soapBody}
    </soapenv:Body>
</soapenv:Envelope>`;

            const options = {
                method: 'POST',
                headers: {
                    'Content-Type': 'text/xml; charset=utf-8',
                    'SOAPAction': serviceConfig.name,
                    'Authorization': GRC_CONFIG.auth.getAuthHeader()
                },
                body: soapEnvelope
            };

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), GRC_CONFIG.server.timeout);

                options.signal = controller.signal;

                const response = await fetch(url, options);
                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const xmlText = await response.text();
                // Parse XML response
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, "text/xml");

                return xmlDoc;
            } catch (error) {
                console.error('GRC SOAP API Error:', error);
                throw error;
            }
        }

        /**
         * Zoek toegangen in GRC AC systeem
         * Gebruikt GRAC_SEARCH_ROLES_WS web service
         */
        async function searchAccessInGrc(searchTerm) {
            try {
                showLoading(true);

                // SOAP body voor GRAC_SEARCH_ROLES_WS
                const soapBody = `
                    <urn:GRAC_SEARCH_ROLES>
                        <SEARCH_STRING>${searchTerm}</SEARCH_STRING>
                    </urn:GRAC_SEARCH_ROLES>
                `;

                const xmlResponse = await callGrcSoapApi('searchRoles', soapBody);

                // Parse response en extract rol informatie
                // RoleName, RoleDesc, System, RoleType
                const roles = [];
                const roleNodes = xmlResponse.getElementsByTagName('ROLE');

                for (let i = 0; i < roleNodes.length; i++) {
                    const roleNode = roleNodes[i];
                    roles.push({
                        id: roleNode.getElementsByTagName('ROLE_ID')[0]?.textContent,
                        name: roleNode.getElementsByTagName('ROLE_NAME')[0]?.textContent,
                        description: roleNode.getElementsByTagName('ROLE_DESC')[0]?.textContent,
                        type: roleNode.getElementsByTagName('ROLE_TYPE')[0]?.textContent,
                        system: roleNode.getElementsByTagName('SYSTEM')[0]?.textContent
                    });
                }

                return roles;
            } catch (error) {
                console.error('Fout bij zoeken in GRC:', error);
                showError('Fout bij het ophalen van gegevens uit GRC systeem. Lokale data wordt gebruikt.');
                return null;
            } finally {
                showLoading(false);
            }
        }

        /**
         * Verstuur access request naar GRC AC backend
         * Gebruikt GRAC_ORG_ASGN_REQUEST_WS web service
         */
        async function submitAccessRequestToGrc(accessRequests) {
            try {
                showLoading(true);

                const currentUser = getCurrentUser();
                const today = new Date().toISOString().split('T')[0];
                const oneYearLater = new Date();
                oneYearLater.setFullYear(oneYearLater.getFullYear() + 1);
                const validTo = oneYearLater.toISOString().split('T')[0];

                // Build rollen lijst voor SOAP request
                const rolesXml = accessRequests.map(role => `
                    <ROLE>
                        <ROLE_NAME>${role.name}</ROLE_NAME>
                        <VALID_FROM>${today}</VALID_FROM>
                        <VALID_TO>${validTo}</VALID_TO>
                    </ROLE>
                `).join('');

                // SOAP body voor GRAC_ORG_ASGN_REQUEST_WS
                const soapBody = `
                    <urn:GRAC_ORG_ASGN_REQUEST>
                        <REQUESTER_ID>${currentUser.userId}</REQUESTER_ID>
                        <USER_ID>${currentUser.userId}</USER_ID>
                        <REF_TICKET_NO>VITENS-AR-${Date.now()}</REF_TICKET_NO>
                        <JUSTIFICATION>Aangevraagd via Vitens Access Request Portal</JUSTIFICATION>
                        <ROLES>
                            ${rolesXml}
                        </ROLES>
                    </urn:GRAC_ORG_ASGN_REQUEST>
                `;

                const xmlResponse = await callGrcSoapApi('createRequest', soapBody);

                // Extract Request ID uit response
                const requestIdNode = xmlResponse.getElementsByTagName('REQUEST_ID')[0];
                const requestId = requestIdNode?.textContent;

                if (!requestId) {
                    throw new Error('Geen Request ID ontvangen van GRC');
                }

                return {
                    success: true,
                    requestId: requestId,
                    message: 'Access request succesvol aangemaakt in SAP GRC'
                };
            } catch (error) {
                console.error('Fout bij indienen aanvraag naar GRC:', error);
                throw error;
            } finally {
                showLoading(false);
            }
        }

        /**
         * Haal huidige gebruiker op (SSO/AD integratie)
         */
        function getCurrentUser() {
            // TODO: Implementeer SSO/AD integratie
            // Voor nu return placeholder
            return {
                userId: 'current.user',
                displayName: 'Huidige Gebruiker',
                email: 'user@vitens.nl',
                department: 'IT'
            };
        }

        // ============================================
        // UI HELPER FUNCTIES
        // ============================================

        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            overlay.style.display = show ? 'flex' : 'none';
        }

        function showSuccess(message) {
            const successMsg = document.getElementById('successMessage');
            successMsg.textContent = message;
            successMsg.style.display = 'block';

            setTimeout(() => {
                successMsg.style.display = 'none';
            }, 5000);
        }

        function showError(message) {
            const errorMsg = document.getElementById('errorMessage');
            errorMsg.textContent = message;
            errorMsg.style.display = 'block';

            setTimeout(() => {
                errorMsg.style.display = 'none';
            }, 5000);
        }

        // ============================================
        // ZOEK FUNCTIONALITEIT
        // ============================================

        async function performSearch() {
            const searchTerm = document.getElementById('searchInput').value.trim();
            const resultsContainer = document.getElementById('resultsContainer');

            // Get filter values
            const afdelingFilter = document.getElementById('afdelingFilter').value;
            const bedrijfsprocesFilter = document.getElementById('bedrijfsprocesFilter').value;

            // Als geen zoekterm EN geen filters, toon melding
            if (searchTerm === '' && !afdelingFilter && !bedrijfsprocesFilter) {
                resultsContainer.innerHTML = '<div class="no-results">Voer een zoekterm in of selecteer een filter</div>';
                return;
            }

            // Bepaal data source op basis van huidige mode
            let dataSource = [];

            switch(currentMode) {
                case 'demo':
                    // Demo mode - gebruik simpele test data (geen errors)
                    dataSource = localAvailableAccess;
                    searchResults = fuzzySearch(searchTerm, dataSource);
                    displayResults();
                    break;

                case 'excel':
                    // Excel mode - gebruik geüploade Excel data
                    if (excelData.length === 0) {
                        resultsContainer.innerHTML = `
                            <div class="no-results">
                                📊 Geen Excel data geladen.<br>
                                Upload eerst een BOR.xlsx bestand hierboven.
                            </div>
                        `;
                        return;
                    }
                    dataSource = excelData;

                    // Apply filters first
                    let filteredData = dataSource;

                    if (afdelingFilter) {
                        filteredData = filteredData.filter(item =>
                            item.functiegebied === afdelingFilter
                        );
                    }

                    if (bedrijfsprocesFilter) {
                        filteredData = filteredData.filter(item =>
                            item.bedrijfsproces === bedrijfsprocesFilter
                        );
                    }

                    // If search term exists, do fuzzy search on filtered data
                    if (searchTerm) {
                        searchResults = fuzzySearch(searchTerm, filteredData);
                    } else {
                        // No search term, just show filtered results (limited to first 100)
                        searchResults = filteredData.slice(0, 100);
                    }

                    displayResults();
                    break;

                case 'online':
                    // Online mode - probeer GRC backend
                    try {
                        showLoading(true);
                        const grcResults = await searchAccessInGrc(searchTerm);

                        if (grcResults && grcResults.length > 0) {
                            let filteredGrcResults = grcResults;

                            // Apply filters if available
                            if (afdelingFilter) {
                                filteredGrcResults = filteredGrcResults.filter(item =>
                                    item.functiegebied === afdelingFilter
                                );
                            }

                            if (bedrijfsprocesFilter) {
                                filteredGrcResults = filteredGrcResults.filter(item =>
                                    item.bedrijfsproces === bedrijfsprocesFilter
                                );
                            }

                            // Pas fuzzy search toe op GRC resultaten
                            searchResults = searchTerm ?
                                fuzzySearch(searchTerm, filteredGrcResults) :
                                filteredGrcResults.slice(0, 100);
                            displayResults();
                        } else {
                            // Geen resultaten van GRC
                            resultsContainer.innerHTML = `
                                <div class="no-results">
                                    Geen rollen gevonden in SAP GRC voor "${searchTerm}"
                                </div>
                            `;
                        }
                        showLoading(false);
                    } catch (error) {
                        // Error handling voor online mode
                        console.error('GRC search error:', error);
                        showLoading(false);

                        resultsContainer.innerHTML = `
                            <div class="no-results">
                                🌐 Kan geen verbinding maken met SAP GRC.<br>
                                <small>Controleer de instellingen (⚙️) of schakel over naar Offline/Demo modus.</small>
                            </div>
                        `;
                    }
                    break;
            }
        }

        // ============================================
        // RESULTATEN WEERGEVEN
        // ============================================

        function displayResults() {
            const resultsContainer = document.getElementById('resultsContainer');
            const resultsHeader = document.querySelector('.results-header');

            if (searchResults.length === 0) {
                resultsHeader.textContent = 'Zoekresultaten';
                resultsContainer.innerHTML = '<div class="no-results">Geen resultaten gevonden. Probeer een andere zoekterm of filter.</div>';
                return;
            }

            // Update header with count
            resultsHeader.textContent = `Zoekresultaten (${searchResults.length})`;

            resultsContainer.innerHTML = searchResults.map(item => {
                const isInCart = cart.some(cartItem => cartItem.id === item.id);
                return `
                    <div class="result-item">
                        <div class="result-info">
                            <div class="result-name">${item.name}</div>
                            <div class="result-description">${item.description}</div>
                            <span class="result-type">${item.type}</span>
                        </div>
                        <button
                            class="add-btn"
                            onclick="addToCart(${item.id})"
                            ${isInCart ? 'disabled' : ''}
                        >
                            ${isInCart ? '✓ Toegevoegd' : 'Toevoegen'}
                        </button>
                    </div>
                `;
            }).join('');
        }

        // ============================================
        // WINKELWAGEN FUNCTIONALITEIT
        // ============================================

        function addToCart(itemId) {
            const item = searchResults.find(a => a.id === itemId) ||
                         localAvailableAccess.find(a => a.id === itemId);

            if (item && !cart.some(cartItem => cartItem.id === itemId)) {
                cart.push(item);
                updateCart();
                displayResults();
            }
        }

        function removeFromCart(itemId) {
            cart = cart.filter(item => item.id !== itemId);
            updateCart();
            displayResults();
        }

        function updateCart() {
            const cartContainer = document.getElementById('cartContainer');
            const cartBadge = document.getElementById('cartBadge');
            const orderBtn = document.getElementById('orderBtn');

            cartBadge.textContent = cart.length;

            if (cart.length === 0) {
                cartContainer.innerHTML = `
                    <div class="empty-cart">
                        <div class="empty-cart-icon">🛒</div>
                        <p>Je winkelwagen is leeg</p>
                    </div>
                `;
                orderBtn.disabled = true;
            } else {
                cartContainer.innerHTML = cart.map(item => `
                    <div class="cart-item">
                        <div class="cart-item-info">
                            <div class="cart-item-name">${item.name}</div>
                            <div class="cart-item-type">${item.type}</div>
                        </div>
                        <button class="remove-btn" onclick="removeFromCart(${item.id})">✕</button>
                    </div>
                `).join('');
                orderBtn.disabled = false;
            }
        }

        // ============================================
        // BESTELLING INDIENEN
        // ============================================

        async function submitOrder() {
            if (cart.length === 0) return;

            try {
                // Behandeling op basis van huidige mode
                switch(currentMode) {
                    case 'demo':
                        // Demo mode - simuleer succesvolle bestelling
                        console.log('Demo: Bestelling ingediend', cart);
                        showSuccess(`✓ Demo: Aanvraag voor ${cart.length} rol(len) succesvol gesimuleerd!`);
                        break;

                    case 'excel':
                        // Excel/Offline mode - simuleer succesvolle bestelling
                        console.log('Offline: Bestelling ingediend', cart);
                        showSuccess(`✓ Offline: Aanvraag voor ${cart.length} rol(len) geregistreerd. Deze wordt verstuurd zodra je online bent.`);
                        break;

                    case 'online':
                        // Online mode - verstuur naar GRC
                        const response = await submitAccessRequestToGrc(cart);

                        if (response.success) {
                            showSuccess(`✓ Je aanvraag is succesvol ingediend in SAP GRC! Aanvraagnummer: ${response.requestId}`);
                        } else {
                            throw new Error('Aanvraag mislukt');
                        }
                        break;
                }

                // Reset winkelwagen
                cart = [];
                updateCart();
                displayResults();

                // Scroll naar boven
                window.scrollTo({ top: 0, behavior: 'smooth' });

            } catch (error) {
                console.error('Fout bij indienen bestelling:', error);

                // Friendly error message afhankelijk van mode
                if (currentMode === 'online') {
                    showError('🌐 Kan geen verbinding maken met SAP GRC. Schakel over naar Offline modus of probeer het later opnieuw.');
                } else {
                    showError('Er is een fout opgetreden. Probeer het opnieuw.');
                }
            }
        }

        // ============================================
        // SETTINGS MANAGEMENT
        // ============================================

        /**
         * Open settings modal
         */
        function openSettings() {
            const modal = document.getElementById('settingsModal');
            modal.classList.add('active');

            // Load saved settings from localStorage
            loadSettings();
        }

        /**
         * Close settings modal
         */
        function closeSettings() {
            const modal = document.getElementById('settingsModal');
            modal.classList.remove('active');
        }

        /**
         * Load settings from localStorage
         */
        function loadSettings() {
            const savedSettings = localStorage.getItem('grc_settings');

            if (savedSettings) {
                const settings = JSON.parse(savedSettings);

                // Server configuratie
                document.getElementById('grcServerUrl').value = settings.serverUrl || 'https://grc.vitens.lan';
                document.getElementById('grcTimeout').value = settings.timeout || 30000;

                // Authenticatie
                document.getElementById('grcUsername').value = settings.username || '';
                document.getElementById('grcPassword').value = settings.password || '';

                // Backend configuratie
                document.getElementById('useBackend').checked = settings.useBackend || false;
                document.getElementById('enablePolling').checked = settings.enablePolling || false;
                document.getElementById('pollingInterval').value = settings.pollingInterval || 15;

                // Web services endpoints
                document.getElementById('wsSearchRoles').value = settings.wsSearchRoles ||
                    '/sap/bc/srt/rfc/sap/grac_search_roles_ws/002/grac_search_roles_ws/grac_search_roles_ws';
                document.getElementById('wsCreateRequest').value = settings.wsCreateRequest ||
                    '/sap/bc/srt/rfc/sap/grac_org_asgn_request_ws/002/grac_org_asgn_request_ws/grac_org_asgn_request_ws';
                document.getElementById('wsRequestStatus').value = settings.wsRequestStatus ||
                    '/sap/bc/srt/rfc/sap/grac_request_status_ws/002/grac_request_status_ws/grac_request_status_ws';
            } else {
                // Set defaults
                document.getElementById('grcServerUrl').value = 'https://grc.vitens.lan';
                document.getElementById('grcTimeout').value = 30000;
                document.getElementById('pollingInterval').value = 15;
            }
        }

        /**
         * Save settings to localStorage
         */
        function saveSettings(event) {
            event.preventDefault();

            const settings = {
                serverUrl: document.getElementById('grcServerUrl').value.trim(),
                timeout: parseInt(document.getElementById('grcTimeout').value),
                username: document.getElementById('grcUsername').value.trim(),
                password: document.getElementById('grcPassword').value, // In productie: encrypt
                useBackend: document.getElementById('useBackend').checked,
                enablePolling: document.getElementById('enablePolling').checked,
                pollingInterval: parseInt(document.getElementById('pollingInterval').value),
                wsSearchRoles: document.getElementById('wsSearchRoles').value.trim(),
                wsCreateRequest: document.getElementById('wsCreateRequest').value.trim(),
                wsRequestStatus: document.getElementById('wsRequestStatus').value.trim()
            };

            // Validatie
            if (!settings.serverUrl) {
                showError('GRC Server URL is verplicht');
                return;
            }

            if (settings.useBackend && (!settings.username || !settings.password)) {
                showError('Username en password zijn verplicht wanneer backend integratie is ingeschakeld');
                return;
            }

            // Save to localStorage
            localStorage.setItem('grc_settings', JSON.stringify(settings));

            // Update GRC_CONFIG
            applySettings(settings);

            showSuccess('✓ Instellingen zijn opgeslagen!');
            closeSettings();
        }

        /**
         * Apply settings to GRC_CONFIG
         */
        function applySettings(settings) {
            // Update server configuratie
            GRC_CONFIG.server.baseUrl = settings.serverUrl;
            GRC_CONFIG.server.timeout = settings.timeout;

            // Update authenticatie
            GRC_CONFIG.auth.username = settings.username;
            GRC_CONFIG.auth.password = settings.password;

            // Update web service endpoints
            GRC_CONFIG.webservices.searchRoles.endpoint = settings.wsSearchRoles;
            GRC_CONFIG.webservices.createRequest.endpoint = settings.wsCreateRequest;
            GRC_CONFIG.webservices.getRequestStatus.endpoint = settings.wsRequestStatus;

            // Update polling
            GRC_CONFIG.polling.enabled = settings.enablePolling;
            GRC_CONFIG.polling.interval = settings.pollingInterval * 60000; // Convert to ms

            // Update useBackend flag
            useBackend = settings.useBackend;

            console.log('GRC Settings applied:', {
                serverUrl: settings.serverUrl,
                useBackend: settings.useBackend,
                username: settings.username ? '***' : '(not set)'
            });
        }

        /**
         * Test GRC connection
         */
        async function testConnection() {
            const statusDiv = document.getElementById('connectionStatus');
            statusDiv.style.display = 'block';
            statusDiv.className = 'connection-status';
            statusDiv.textContent = 'Bezig met testen van connectie...';

            try {
                // Temporarily apply settings for test
                const tempSettings = {
                    serverUrl: document.getElementById('grcServerUrl').value.trim(),
                    timeout: parseInt(document.getElementById('grcTimeout').value),
                    username: document.getElementById('grcUsername').value.trim(),
                    password: document.getElementById('grcPassword').value
                };

                if (!tempSettings.serverUrl || !tempSettings.username || !tempSettings.password) {
                    throw new Error('Vul alle verplichte velden in');
                }

                // Simple test: try to search with empty string
                const testUrl = tempSettings.serverUrl +
                    document.getElementById('wsSearchRoles').value;

                const soapEnvelope = `<?xml version="1.0" encoding="UTF-8"?>
<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:urn="urn:sap-com:document:sap:rfc:functions">
    <soapenv:Header/>
    <soapenv:Body>
        <urn:GRAC_SEARCH_ROLES>
            <SEARCH_STRING>TEST</SEARCH_STRING>
        </urn:GRAC_SEARCH_ROLES>
    </soapenv:Body>
</soapenv:Envelope>`;

                const credentials = btoa(`${tempSettings.username}:${tempSettings.password}`);

                const response = await fetch(testUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/xml; charset=utf-8',
                        'SOAPAction': 'GRAC_SEARCH_ROLES_WS',
                        'Authorization': `Basic ${credentials}`
                    },
                    body: soapEnvelope,
                    signal: AbortSignal.timeout(tempSettings.timeout)
                });

                if (response.ok) {
                    statusDiv.className = 'connection-status success';
                    statusDiv.textContent = '✓ Connectie succesvol! GRC server is bereikbaar.';
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                statusDiv.className = 'connection-status error';
                statusDiv.textContent = `✗ Connectie mislukt: ${error.message}. Controleer server URL en credentials.`;
                console.error('Connection test failed:', error);
            }
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================

        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                performSearch();
            }
        });

        // Settings form submit
        document.getElementById('settingsForm').addEventListener('submit', saveSettings);

        // Close modal when clicking outside
        document.getElementById('settingsModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeSettings();
            }
        });

        // Load settings on page load
        window.addEventListener('load', function() {
            document.getElementById('searchInput').focus();

            // Load saved settings if available
            const savedSettings = localStorage.getItem('grc_settings');
            if (savedSettings) {
                const settings = JSON.parse(savedSettings);
                applySettings(settings);
            }
        });
    </script>
</body>
</html>